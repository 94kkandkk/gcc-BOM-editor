<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑BOM表 - GCC BOM管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background: #f5f7fa;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            height: 100vh;
            overflow: hidden;
        }
        /* 顶部导航 */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .nav-title {
            font-size: 20px;
            color: #2c3e50;
            font-weight: 600;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }
        .btn-primary {
            background: #3498db;
            color: #fff;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #2ecc71;
            color: #fff;
        }
        .btn-success:hover {
            background: #27ae60;
        }
        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        /* 核心编辑区：左树状 + 右编辑 分栏布局 */
        .main-edit {
            display: flex;
            gap: 20px;
            height: calc(100vh - 110px);
        }
        /* 左侧BOM树状结构区（固定宽度，可滚动） */
        .bom-tree-area {
            flex: 0 0 400px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 25px;
            overflow-y: auto;
        }
        /* 右侧零件编辑区（自适应宽度，可滚动） */
        .part-edit-area {
            flex: 1;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 25px;
            overflow-y: auto;
        }
        .tree-title, .edit-title {
            font-size: 18px;
            color: #34495e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tree-desc, .edit-desc {
            font-size: 14px;
            color: #95a5a6;
            font-weight: 400;
        }
        .tree-empty, .edit-tip {
            text-align: center;
            padding: 40px 0;
            color: #95a5a6;
            font-size: 16px;
            border: 1px dashed #eee;
            border-radius: 6px;
            margin-top: 20px;
        }
        /* 树节点样式（修复选中/点击BUG） */
        .tree-node {
            margin-left: 28px;
            line-height: 40px;
            cursor: pointer;
            border-radius: 6px;
            padding: 0 10px;
            position: relative;
            user-select: none;
        }
        .tree-root-node {
            margin-left: 0;
        }
        .tree-node:hover {
            background: #eef2f7;
        }
        .tree-node.active {
            background: #3498db;
            color: #fff;
        }
        /* 节点图标（独立点击区域，修复折叠BUG） */
        .node-icon {
            display: inline-block;
            width: 24px;
            text-align: center;
            user-select: none;
            margin-right: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        /* 表单样式 */
        .part-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        .form-input {
            padding: 12px;
            border: 1px solid #dcdfe6;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }
        .form-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
        }
        .form-item-full {
            grid-column: 1 / 3;
        }
        textarea.form-input {
            resize: vertical;
            min-height: 120px;
        }
        /* 操作按钮组 */
        .opt-btn-group {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            grid-column: 1 / 3;
        }
    </style>
</head>
<body>
    <!-- 顶部导航：BOM名称 + 全局操作 -->
    <div class="nav">
        <div class="nav-title" id="bomTitle">编辑BOM表</div>
        <div>
            <button class="btn btn-primary" id="addRootBtn">新增根零件</button>
            <button class="btn btn-success" id="saveBomBtn">保存BOM表</button>
            <button class="btn btn-primary" id="backHomeBtn">返回首页</button>
        </div>
    </div>

    <!-- 核心编辑区：左树状结构 + 右零件编辑（恢复分栏） -->
    <div class="main-edit">
        <!-- 左侧：BOM树状结构展示区 -->
        <div class="bom-tree-area">
            <div class="tree-title">
                <span>BOM树状结构</span>
                <span class="tree-desc">（支持多根零件/无限子层级）</span>
            </div>
            <div id="treeContainer">
                <div class="tree-empty">暂无零件<br>点击顶部「新增根零件」开始创建</div>
            </div>
        </div>

        <!-- 右侧：零件信息编辑区 -->
        <div class="part-edit-area">
            <div class="edit-title">
                <span>零件信息编辑</span>
                <span class="edit-desc">（先选左侧零件，再编辑信息）</span>
            </div>
            <!-- 未选中零件提示 -->
            <div class="edit-tip" id="editTip">
                请先在左侧选择需要编辑的零件节点<br>
                点击节点图标「▶/▼」折叠/展开层级<br>
                点击节点名称选中并加载编辑信息
            </div>
            <!-- 零件编辑表单 -->
            <form class="part-form" id="partForm" style="display: none;">
                <div class="form-item">
                    <label class="form-label" for="partName">零件名称 *</label>
                    <input type="text" class="form-input" id="partName" placeholder="请输入零件名称（必填）">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partModel">零件型号</label>
                    <input type="text" class="form-input" id="partModel" placeholder="请输入零件型号/编号">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partMaterial">零件材质</label>
                    <input type="text" class="form-input" id="partMaterial" placeholder="如：不锈钢/ABS塑料/铝合金">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partSpec">规格参数</label>
                    <input type="text" class="form-input" id="partSpec" placeholder="请输入零件规格/技术参数">
                </div>
                <div class="form-item form-item-full">
                    <label class="form-label" for="partRemark">备注信息</label>
                    <textarea class="form-input" id="partRemark" placeholder="请输入备注、供应商、采购信息等（选填）"></textarea>
                </div>
                <!-- 零件操作按钮 -->
                <div class="opt-btn-group">
                    <button type="button" class="btn btn-primary" id="addChildBtn">为当前零件新增子零件</button>
                    <button type="button" class="btn btn-danger" id="deletePartBtn">删除当前零件（含子零件）</button>
                    <button type="button" class="btn btn-success" id="savePartBtn">保存当前零件信息</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let currentBomId = '';
        let currentNodeId = null;
        let bomData = { rootNodes: [], nodeIdGenerator: 1 };
        let bomName = '';

        // 页面加载初始化
        window.onload = function() {
            currentBomId = getUrlParam('bomId');
            if (!currentBomId) {
                alert('无效的BOM表！即将返回首页');
                window.location.href = 'index.html';
                return;
            }
            loadBomData();
            loadBomName();
            renderBomTree();
            bindEvents();
        };

        // 从URL获取BOM ID
        function getUrlParam(name) {
            const reg = new RegExp(`(^|&)${name}=([^&]*)(&|$)`);
            const r = window.location.search.substr(1).match(reg);
            return r ? decodeURIComponent(r[2]) : '';
        }

        // 加载BOM数据
        function loadBomData() {
            const savedData = localStorage.getItem(`gcc-bom-data-${currentBomId}`);
            if (savedData) bomData = JSON.parse(savedData);
        }

        // 加载BOM名称
        function loadBomName() {
            const savedBoms = JSON.parse(localStorage.getItem('gcc-bom-list')) || [];
            const currentBom = savedBoms.find(bom => bom.id === currentBomId);
            if (currentBom) {
                bomName = currentBom.name;
                document.getElementById('bomTitle').innerText = `编辑BOM表：${bomName}`;
            } else {
                alert('BOM表不存在！即将返回首页');
                window.location.href = 'index.html';
            }
        }

        // 渲染BOM树（核心修复：递归渲染+独立节点标识）
        function renderBomTree() {
            const treeContainer = document.getElementById('treeContainer');
            if (bomData.rootNodes.length === 0) {
                treeContainer.innerHTML = '<div class="tree-empty">暂无零件<br>点击顶部「新增根零件」开始创建</div>';
                return;
            }
            treeContainer.innerHTML = '';
            bomData.rootNodes.forEach(node => {
                treeContainer.appendChild(renderTreeNode(node, true));
            });
        }

        // 递归渲染单个节点（修复：独立图标DOM，避免点击冒泡）
        function renderTreeNode(node, isRoot = false) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `tree-node ${isRoot ? 'tree-root-node' : ''} ${node.id === currentNodeId ? 'active' : ''}`;
            nodeDiv.dataset.nodeid = node.id; // 节点专属标识，避免和图标冲突

            // 单独创建图标DOM（核心：独立点击区域，修复折叠/选中冲突）
            const iconSpan = document.createElement('span');
            iconSpan.className = 'node-icon';
            iconSpan.dataset.iconid = node.id; // 图标专属标识
            iconSpan.innerText = node.children && node.children.length > 0 ? (node.expanded ? '▼' : '▶') : '●';

            // 节点名称DOM
            const nameSpan = document.createElement('span');
            nameSpan.innerText = node.name || '未命名零件';

            // 组装节点
            nodeDiv.appendChild(iconSpan);
            nodeDiv.appendChild(nameSpan);

            // 递归渲染子节点（仅展开时显示）
            if (node.children && node.children.length > 0 && node.expanded) {
                const childWrap = document.createElement('div');
                node.children.forEach(child => {
                    childWrap.appendChild(renderTreeNode(child));
                });
                nodeDiv.appendChild(childWrap);
            }
            return nodeDiv;
        }

        // 绑定事件（核心修复：区分图标/节点点击，避免冒泡）
        function bindEvents() {
            // 顶部导航事件
            document.getElementById('addRootBtn').onclick = addRootPart;
            document.getElementById('saveBomBtn').onclick = saveWholeBom;
            document.getElementById('backHomeBtn').onclick = () => window.location.href = 'index.html';
            // 编辑区事件
            document.getElementById('addChildBtn').onclick = addChildPart;
            document.getElementById('deletePartBtn').onclick = deleteCurrentPart;
            document.getElementById('savePartBtn').onclick = saveCurrentPart;
            // 树容器事件（核心：委托+区分图标/节点，阻止冒泡）
            document.getElementById('treeContainer').addEventListener('click', function(e) {
                const target = e.target;
                // 点击图标：折叠/展开（阻止冒泡，避免触发节点选中）
                if (target.classList.contains('node-icon')) {
                    e.stopPropagation(); // 关键：阻止事件冒泡到节点
                    const nodeId = target.dataset.iconid;
                    nodeId && toggleNodeExpanded(nodeId);
                    return;
                }
                // 点击节点（含名称）：选中并加载编辑信息
                const nodeDiv = target.closest('.tree-node'); // 关键：获取最外层节点DOM
                if (nodeDiv) {
                    const nodeId = nodeDiv.dataset.nodeid;
                    nodeId && selectTreeNode(nodeId);
                }
            });
        }

        // 新增根零件（支持多个独立根零件，无层级关联）
        function addRootPart() {
            const newNode = createNewNode('新根零件');
            bomData.rootNodes.push(newNode);
            saveBomData();
            renderBomTree();
            selectTreeNode(newNode.id); // 自动选中新根零件
        }

        // 新增子零件
        function addChildPart() {
            if (!currentNodeId) {
                alert('请先在左侧选择一个零件作为父零件！');
                return;
            }
            const parentNode = findNodeById(currentNodeId);
            if (!parentNode) return;
            const newNode = createNewNode('新子零件');
            if (!parentNode.children) parentNode.children = [];
            parentNode.children.push(newNode);
            parentNode.expanded = true; // 自动展开父节点
            saveBomData();
            renderBomTree();
            selectTreeNode(newNode.id);
        }

        // 删除当前零件
        function deleteCurrentPart() {
            if (!currentNodeId) {
                alert('请先选择要删除的零件！');
                return;
            }
            if (!confirm('警告！将删除当前零件及所有子零件，操作不可恢复！确认删除？')) return;

            // 删除根节点
            const rootIndex = bomData.rootNodes.findIndex(n => n.id === currentNodeId);
            if (rootIndex > -1) {
                bomData.rootNodes.splice(rootIndex, 1);
                saveBomData();
                renderBomTree();
                resetEditArea();
                return;
            }
            // 递归删除子节点
            deleteChildNode(currentNodeId, bomData.rootNodes);
            saveBomData();
            renderBomTree();
            resetEditArea();
        }

        // 保存当前零件信息
        function saveCurrentPart() {
            if (!currentNodeId) return;
            const node = findNodeById(currentNodeId);
            if (!node) return;

            const partName = document.getElementById('partName').value.trim();
            if (!partName) {
                alert('零件名称不能为空！');
                document.getElementById('partName').focus();
                return;
            }

            // 更新节点信息
            node.name = partName;
            node.model = document.getElementById('partModel').value.trim();
            node.material = document.getElementById('partMaterial').value.trim();
            node.spec = document.getElementById('partSpec').value.trim();
            node.remark = document.getElementById('partRemark').value.trim();

            saveBomData();
            renderBomTree();
            alert('零件信息保存成功！');
        }

        // 保存整个BOM表
        function saveWholeBom() {
            saveBomData();
            // 更新修改时间
            const savedBoms = JSON.parse(localStorage.getItem('gcc-bom-list')) || [];
            const bomIndex = savedBoms.findIndex(b => b.id === currentBomId);
            if (bomIndex > -1) {
                savedBoms[bomIndex].updateTime = Date.now();
                localStorage.setItem('gcc-bom-list', JSON.stringify(savedBoms));
            }
            alert(`BOM表「${bomName}」保存成功！`);
        }

        // 选中节点（核心修复：支持所有节点，包括根节点/父节点）
        function selectTreeNode(nodeId) {
            const node = findNodeById(nodeId);
            if (!node) return;
            currentNodeId = nodeId;
            // 显示表单，隐藏提示
            document.getElementById('editTip').style.display = 'none';
            document.getElementById('partForm').style.display = 'grid';
            // 填充表单数据
            document.getElementById('partName').value = node.name || '';
            document.getElementById('partModel').value = node.model || '';
            document.getElementById('partMaterial').value = node.material || '';
            document.getElementById('partSpec').value = node.spec || '';
            document.getElementById('partRemark').value = node.remark || '';
            // 重新渲染树，更新高亮
            renderBomTree();
        }

        // 折叠/展开节点（核心修复：单独控制，无冲突）
        function toggleNodeExpanded(nodeId) {
            const node = findNodeById(nodeId);
            if (!node || !node.children || node.children.length === 0) return;
            node.expanded = !node.expanded;
            saveBomData();
            renderBomTree();
        }

        // 重置编辑区
        function resetEditArea() {
            currentNodeId = null;
            document.getElementById('editTip').style.display = 'block';
            document.getElementById('partForm').style.display = 'none';
        }

        // 工具方法：创建新节点
        function createNewNode(name) {
            return {
                id: bomData.nodeIdGenerator++,
                name: name,
                model: '',
                material: '',
                spec: '',
                remark: '',
                expanded: false,
                children: []
            };
        }

        // 工具方法：递归查找节点（修复：支持所有层级节点查找）
        function findNodeById(nodeId, nodeList = bomData.rootNodes) {
            for (const node of nodeList) {
                if (node.id === nodeId) return node;
                if (node.children && node.children.length > 0) {
                    const res = findNodeById(nodeId, node.children);
                    if (res) return res;
                }
            }
            return null;
        }

        // 工具方法：递归删除节点
        function deleteChildNode(nodeId, nodeList = bomData.rootNodes) {
            for (let i = 0; i < nodeList.length; i++) {
                if (nodeList[i].id === nodeId) {
                    nodeList.splice(i, 1);
                    return true;
                }
                if (nodeList[i].children && nodeList[i].children.length > 0) {
                    const res = deleteChildNode(nodeId, nodeList[i].children);
                    if (res) return true;
                }
            }
            return false;
        }

        // 保存BOM数据到本地
        function saveBomData() {
            localStorage.setItem(`gcc-bom-data-${currentBomId}`, JSON.stringify(bomData));
        }
    </script>
</body>
</html>
