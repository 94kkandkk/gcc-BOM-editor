<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑BOM表 - GCC BOM管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background: #f5f7fa;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        /* 顶部导航 */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .nav-title {
            font-size: 20px;
            color: #2c3e50;
            font-weight: 600;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }
        .btn-primary {
            background: #3498db;
            color: #fff;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #2ecc71;
            color: #fff;
        }
        .btn-success:hover {
            background: #27ae60;
        }
        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        /* 核心编辑区 */
        .edit-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            padding: 25px;
        }
        /* BOM树状结构区 */
        .bom-tree-area {
            margin-bottom: 30px;
        }
        .tree-title {
            font-size: 18px;
            color: #34495e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tree-empty {
            text-align: center;
            padding: 40px 0;
            color: #95a5a6;
            font-size: 16px;
            border: 1px dashed #eee;
            border-radius: 6px;
        }
        /* 树节点样式 */
        .tree-node {
            margin-left: 28px;
            line-height: 40px;
            cursor: pointer;
            border-radius: 6px;
            padding: 0 10px;
            position: relative;
        }
        /* 根节点无左侧缩进 */
        .tree-root-node {
            margin-left: 0;
        }
        .tree-node:hover {
            background: #eef2f7;
        }
        .tree-node.active {
            background: #3498db;
            color: #fff;
        }
        .node-icon {
            display: inline-block;
            width: 24px;
            text-align: center;
            user-select: none;
            margin-right: 6px;
            font-size: 14px;
        }
        /* 零件编辑区 */
        .part-edit-area {
            border-top: 1px solid #eee;
            padding-top: 30px;
        }
        .edit-title {
            font-size: 18px;
            color: #34495e;
            margin-bottom: 20px;
        }
        .edit-tip {
            text-align: center;
            padding: 40px 0;
            color: #95a5a6;
            font-size: 16px;
        }
        /* 表单样式 */
        .part-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        .form-input {
            padding: 12px;
            border: 1px solid #dcdfe6;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }
        .form-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
        }
        .form-item-full {
            grid-column: 1 / 3;
        }
        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }
        /* 操作按钮组 */
        .opt-btn-group {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- 顶部导航：BOM名称 + 操作按钮 -->
    <div class="nav">
        <div class="nav-title" id="bomTitle">编辑BOM表</div>
        <div>
            <button class="btn btn-primary" id="addRootBtn">新增根零件</button>
            <button class="btn btn-success" id="saveBomBtn">保存BOM表</button>
            <button class="btn btn-primary" id="backHomeBtn">返回首页</button>
        </div>
    </div>

    <!-- 核心编辑容器 -->
    <div class="edit-container">
        <!-- BOM树状结构展示区 -->
        <div class="bom-tree-area">
            <div class="tree-title">
                <span>BOM树状结构</span>
                <span style="font-size:14px;color:#95a5a6;font-weight:400;">（点击节点选中/编辑，点击▶/▼折叠/展开层级）</span>
            </div>
            <div id="treeContainer">
                <div class="tree-empty">暂无零件，点击「新增根零件」开始创建BOM结构</div>
            </div>
        </div>

        <!-- 零件信息编辑区 -->
        <div class="part-edit-area">
            <h3 class="edit-title">零件信息编辑</h3>
            <div class="edit-tip" id="editTip">请先选择左侧的零件节点进行编辑</div>
            
            <form class="part-form" id="partForm" style="display: none;">
                <div class="form-item">
                    <label class="form-label" for="partName">零件名称 *</label>
                    <input type="text" class="form-input" id="partName" placeholder="请输入零件名称">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partModel">零件型号</label>
                    <input type="text" class="form-input" id="partModel" placeholder="请输入零件型号">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partMaterial">零件材质</label>
                    <input type="text" class="form-input" id="partMaterial" placeholder="如：不锈钢/ABS塑料/铝合金">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partSpec">规格参数</label>
                    <input type="text" class="form-input" id="partSpec" placeholder="请输入零件规格/参数">
                </div>
                <div class="form-item form-item-full">
                    <label class="form-label" for="partRemark">备注信息</label>
                    <textarea class="form-input" id="partRemark" placeholder="请输入零件备注、供应商信息等（选填）"></textarea>
                </div>

                <div class="opt-btn-group form-item-full">
                    <button type="button" class="btn btn-primary" id="addChildBtn">为当前零件新增子零件</button>
                    <button type="button" class="btn btn-danger" id="deletePartBtn">删除当前零件（含子零件）</button>
                    <button type="button" class="btn btn-success" id="savePartBtn">保存当前零件信息</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let currentBomId = ''; // 当前编辑的BOM ID
        let currentNodeId = null; // 当前选中的零件节点ID
        let bomData = { rootNodes: [], nodeIdGenerator: 1 }; // BOM核心数据
        let bomName = ''; // BOM表名称

        // 页面加载初始化
        window.onload = function() {
            // 获取URL中的BOM ID，验证有效性
            currentBomId = getUrlParam('bomId');
            if (!currentBomId) {
                alert('无效的BOM表！即将返回首页');
                window.location.href = 'index.html';
                return;
            }
            // 加载BOM数据和名称
            loadBomData();
            loadBomName();
            // 渲染树结构
            renderBomTree();
            // 绑定所有事件
            bindEvents();
        };

        // 从URL获取参数
        function getUrlParam(name) {
            const reg = new RegExp(`(^|&)${name}=([^&]*)(&|$)`);
            const r = window.location.search.substr(1).match(reg);
            return r ? decodeURIComponent(r[2]) : '';
        }

        // 加载BOM核心数据（根节点+ID生成器）
        function loadBomData() {
            const savedData = localStorage.getItem(`gcc-bom-data-${currentBomId}`);
            if (savedData) {
                bomData = JSON.parse(savedData);
            }
        }

        // 加载BOM表名称
        function loadBomName() {
            const savedBoms = JSON.parse(localStorage.getItem('gcc-bom-list')) || [];
            const currentBom = savedBoms.find(bom => bom.id === currentBomId);
            if (currentBom) {
                bomName = currentBom.name;
                document.getElementById('bomTitle').innerText = `编辑BOM表：${bomName}`;
            } else {
                alert('BOM表不存在！即将返回首页');
                window.location.href = 'index.html';
            }
        }

        // 渲染BOM树状结构
        function renderBomTree() {
            const treeContainer = document.getElementById('treeContainer');
            if (bomData.rootNodes.length === 0) {
                treeContainer.innerHTML = '<div class="tree-empty">暂无零件，点击「新增根零件」开始创建BOM结构</div>';
                return;
            }
            treeContainer.innerHTML = '';
            // 渲染所有根节点
            bomData.rootNodes.forEach(node => {
                const nodeEl = renderTreeNode(node, true); // true表示是根节点
                treeContainer.appendChild(nodeEl);
            });
        }

        // 递归渲染单个树节点（支持无限层级）
        function renderTreeNode(node, isRoot = false) {
            const div = document.createElement('div');
            // 根节点添加专属类，取消左侧缩进
            div.className = `tree-node ${isRoot ? 'tree-root-node' : ''} ${node.id === currentNodeId ? 'active' : ''}`;
            div.dataset.id = node.id;

            // 节点图标：有子节点显示▶/▼，无子节点显示●
            const icon = node.children && node.children.length > 0 
                ? (node.expanded ? '▼' : '▶') 
                : '●';
            div.innerHTML = `<span class="node-icon" data-id="${node.id}">${icon}</span>${node.name || '未命名零件'}`;

            // 递归渲染子节点（仅展开时显示）
            if (node.children && node.children.length > 0 && node.expanded) {
                const childContainer = document.createElement('div');
                node.children.forEach(child => {
                    childContainer.appendChild(renderTreeNode(child));
                });
                div.appendChild(childContainer);
            }
            return div;
        }

        // 绑定所有事件
        function bindEvents() {
            // 顶部导航按钮
            document.getElementById('addRootBtn').addEventListener('click', addRootPart);
            document.getElementById('saveBomBtn').addEventListener('click', saveWholeBom);
            document.getElementById('backHomeBtn').addEventListener('click', () => window.location.href = 'index.html');
            // 零件编辑按钮
            document.getElementById('addChildBtn').addEventListener('click', addChildPart);
            document.getElementById('deletePartBtn').addEventListener('click', deleteCurrentPart);
            document.getElementById('savePartBtn').addEventListener('click', saveCurrentPart);
            // 树容器事件委托（选中节点、折叠/展开）
            document.getElementById('treeContainer').addEventListener('click', handleTreeClick);
        }

        // 树容器点击事件处理（选中/折叠/展开）
        function handleTreeClick(e) {
            const target = e.target;
            const nodeId = target.dataset.id || target.parentElement.dataset.id;
            if (!nodeId) return;

            // 点击图标：折叠/展开层级
            if (target.classList.contains('node-icon')) {
                toggleNodeExpanded(nodeId);
                return;
            }
            // 点击节点：选中并加载编辑信息
            selectTreeNode(nodeId);
        }

        // 新增根零件（解决原问题：添加到根节点数组，非第一个子节点）
        function addRootPart() {
            const newRootNode = createNewNode('新根零件');
            bomData.rootNodes.push(newRootNode); // 直接添加到根节点数组
            saveBomData(); // 保存BOM数据
            renderBomTree(); // 重新渲染
            selectTreeNode(newRootNode.id); // 自动选中新节点
        }

        // 为当前选中零件新增子零件
        function addChildPart() {
            if (!currentNodeId) {
                alert('请先选择一个零件作为父零件！');
                return;
            }
            const parentNode = findNodeById(currentNodeId);
            if (!parentNode) return;

            const newChildNode = createNewNode('新子零件');
            if (!parentNode.children) parentNode.children = [];
            parentNode.children.push(newChildNode);
            parentNode.expanded = true; // 自动展开父节点
            saveBomData();
            renderBomTree();
            selectTreeNode(newChildNode.id);
        }

        // 删除当前选中的零件
        function deleteCurrentPart() {
            if (!currentNodeId) {
                alert('请先选择要删除的零件！');
                return;
            }
            if (!confirm('警告！该操作将删除当前零件及所有子零件，且无法恢复！确认删除？')) {
                return;
            }

            // 先尝试删除根节点
            const rootIndex = bomData.rootNodes.findIndex(node => node.id === currentNodeId);
            if (rootIndex > -1) {
                bomData.rootNodes.splice(rootIndex, 1);
                saveBomData();
                renderBomTree();
                resetEditArea();
                return;
            }

            // 递归删除子节点
            deleteChildNode(currentNodeId, bomData.rootNodes);
            saveBomData();
            renderBomTree();
            resetEditArea();
        }

        // 保存当前选中零件的信息
        function saveCurrentPart() {
            if (!currentNodeId) return;
            const node = findNodeById(currentNodeId);
            if (!node) return;

            // 获取表单值
            const partName = document.getElementById('partName').value.trim();
            const partModel = document.getElementById('partModel').value.trim();
            const partMaterial = document.getElementById('partMaterial').value.trim();
            const partSpec = document.getElementById('partSpec').value.trim();
            const partRemark = document.getElementById('partRemark').value.trim();

            // 验证名称非空
            if (!partName) {
                alert('零件名称不能为空！');
                document.getElementById('partName').focus();
                return;
            }

            // 更新节点信息
            node.name = partName;
            node.model = partModel;
            node.material = partMaterial;
            node.spec = partSpec;
            node.remark = partRemark;

            saveBomData();
            renderBomTree();
            alert('零件信息保存成功！');
        }

        // 保存整个BOM表（更新修改时间）
        function saveWholeBom() {
            saveBomData();
            // 更新BOM列表中的修改时间
            const savedBoms = JSON.parse(localStorage.getItem('gcc-bom-list')) || [];
            const bomIndex = savedBoms.findIndex(bom => bom.id === currentBomId);
            if (bomIndex > -1) {
                savedBoms[bomIndex].updateTime = Date.now();
                localStorage.setItem('gcc-bom-list', JSON.stringify(savedBoms));
            }
            alert(`BOM表「${bomName}」保存成功！`);
        }

        // 选中树节点并加载编辑信息
        function selectTreeNode(nodeId) {
            const node = findNodeById(nodeId);
            if (!node) return;

            currentNodeId = nodeId;
            // 显示编辑表单，隐藏提示
            document.getElementById('editTip').style.display = 'none';
            document.getElementById('partForm').style.display = 'grid';
            // 填充表单数据
            document.getElementById('partName').value = node.name || '';
            document.getElementById('partModel').value = node.model || '';
            document.getElementById('partMaterial').value = node.material || '';
            document.getElementById('partSpec').value = node.spec || '';
            document.getElementById('partRemark').value = node.remark || '';
            // 重新渲染树（更新选中高亮）
            renderBomTree();
        }

        // 折叠/展开节点层级（解决原折叠失效问题）
        function toggleNodeExpanded(nodeId) {
            const node = findNodeById(nodeId);
            if (!node || !node.children || node.children.length === 0) return;
            node.expanded = !node.expanded;
            saveBomData();
            renderBomTree();
        }

        // 重置编辑区（无选中节点时）
        function resetEditArea() {
            currentNodeId = null;
            document.getElementById('editTip').style.display = 'block';
            document.getElementById('partForm').style.display = 'none';
        }

        // 工具方法：创建新节点（统一格式）
        function createNewNode(name) {
            const newNode = {
                id: bomData.nodeIdGenerator++,
                name: name,
                model: '',
                material: '',
                spec: '',
                remark: '',
                expanded: false,
                children: []
            };
            return newNode;
        }

        // 工具方法：递归根据ID查找节点（解决原选中失效问题）
        function findNodeById(nodeId, nodeList = bomData.rootNodes) {
            for (const node of nodeList) {
                if (node.id === nodeId) return node;
                if (node.children && node.children.length > 0) {
                    const res = findNodeById(nodeId, node.children);
                    if (res) return res;
                }
            }
            return null;
        }

        // 工具方法：递归删除子节点
        function deleteChildNode(nodeId, nodeList = bomData.rootNodes) {
            for (let i = 0; i < nodeList.length; i++) {
                if (nodeList[i].id === nodeId) {
                    nodeList.splice(i, 1);
                    return true;
                }
                if (nodeList[i].children && nodeList[i].children.length > 0) {
                    const res = deleteChildNode(nodeId, nodeList[i].children);
                    if (res) return true;
                }
            }
            return false;
        }

        // 保存BOM数据到本地存储
        function saveBomData() {
            localStorage.setItem(`gcc-bom-data-${currentBomId}`, JSON.stringify(bomData));
        }
    </script>
</body>
</html>
