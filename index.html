<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCC 零部件树状编辑器</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            background-color: #f5f7fa;
            padding: 20px;
            color: #333;
        }
        /* 页面标题 */
        .page-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
        }
        /* 主容器：左树状展示 + 右编辑区 */
        .main-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 100px);
        }
        /* 左侧树状结构区 */
        .tree-area {
            flex: 1;
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-y: auto;
        }
        .tree-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #34495e;
        }
        .tree-empty {
            text-align: center;
            color: #95a5a6;
            padding: 40px 0;
        }
        /* 树节点样式 */
        .tree-node {
            margin-left: 20px;
            line-height: 36px;
            cursor: pointer;
            border-radius: 4px;
            padding: 0 8px;
        }
        .tree-node:first-child {
            margin-left: 0;
        }
        .tree-node:hover {
            background-color: #eef2f7;
        }
        .tree-node.active {
            background-color: #3498db;
            color: #fff;
        }
        .node-icon {
            display: inline-block;
            width: 20px;
            text-align: center;
            user-select: none;
        }
        /* 右侧编辑区 */
        .edit-area {
            flex: 1;
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }
        .edit-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #34495e;
        }
        .edit-tip {
            color: #95a5a6;
            text-align: center;
            padding: 40px 0;
            flex: 1;
        }
        /* 表单样式 */
        .form-item {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        .form-input {
            padding: 10px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        .form-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52,152,219,0.2);
        }
        .form-input:disabled {
            background-color: #f5f7fa;
            cursor: not-allowed;
        }
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }
        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #3498db;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .edit-btn-group {
            margin-top: auto;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <!-- 页面标题 -->
    <h1 class="page-title">GCC 产品零部件树状信息编辑器</h1>

    <!-- 顶部全局操作按钮 -->
    <div class="btn-group">
        <button class="btn btn-primary" id="addRootBtn">新增根零件</button>
    </div>

    <!-- 主容器：左树右编辑 -->
    <div class="main-container">
        <!-- 左侧树状结构展示区 -->
        <div class="tree-area">
            <h3 class="tree-title">零部件树状结构</h3>
            <div id="treeContainer">
                <div class="tree-empty">暂无零部件，点击「新增根零件」开始创建</div>
            </div>
        </div>

        <!-- 右侧零件信息编辑区 -->
        <div class="edit-area">
            <h3 class="edit-title">零件信息编辑</h3>
            <div class="edit-tip" id="editTip">请先选择左侧的零部件节点</div>
            <form id="partForm" style="display: none; flex: 1; flex-direction: column;">
                <div class="form-item">
                    <label class="form-label" for="partName">零件名称 *</label>
                    <input type="text" class="form-input" id="partName" placeholder="请输入零件名称">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partModel">零件型号</label>
                    <input type="text" class="form-input" id="partModel" placeholder="请输入零件型号">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partMaterial">零件材质</label>
                    <input type="text" class="form-input" id="partMaterial" placeholder="请输入零件材质（如：不锈钢/塑料）">
                </div>
                <div class="form-item">
                    <label class="form-label" for="partRemark">备注信息</label>
                    <textarea class="form-input" id="partRemark" placeholder="请输入零件备注（选填）"></textarea>
                </div>
                <div class="edit-btn-group">
                    <button type="button" class="btn btn-primary" id="addChildBtn">新增子零件</button>
                    <button type="button" class="btn btn-danger" id="deletePartBtn">删除当前零件</button>
                    <button type="button" class="btn btn-primary" id="savePartBtn">保存信息</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量：当前选中节点ID、零部件树数据
        let currentNodeId = null;
        let partTreeData = [];
        // 节点ID自增器（保证唯一）
        let nodeIdGenerator = 1;

        // -------------------------- 初始化页面 --------------------------
        window.onload = function() {
            // 从LocalStorage加载数据
            loadFromLocal();
            // 渲染树状结构
            renderTree();
            // 绑定所有事件
            bindEvents();
        };

        // -------------------------- 树状结构渲染 --------------------------
        function renderTree() {
            const treeContainer = document.getElementById('treeContainer');
            // 无数据时显示引导
            if (partTreeData.length === 0) {
                treeContainer.innerHTML = '<div class="tree-empty">暂无零部件，点击「新增根零件」开始创建</div>';
                return;
            }
            // 有数据时渲染树节点
            treeContainer.innerHTML = '';
            partTreeData.forEach(node => {
                treeContainer.appendChild(renderNode(node));
            });
        }

        // 递归渲染单个节点（支持无限层级）
        function renderNode(node) {
            const div = document.createElement('div');
            div.className = `tree-node ${node.id === currentNodeId ? 'active' : ''}`;
            div.dataset.id = node.id;
            // 节点图标：有子节点显示折叠/展开，无子节点显示圆点
            const icon = node.children && node.children.length > 0 
                ? (node.expanded ? '▼' : '▶') 
                : '●';
            div.innerHTML = `<span class="node-icon" data-id="${node.id}">${icon}</span>${node.name}`;
            
            // 渲染子节点（递归）
            if (node.children && node.children.length > 0 && node.expanded) {
                const childContainer = document.createElement('div');
                node.children.forEach(child => {
                    childContainer.appendChild(renderNode(child));
                });
                div.appendChild(childContainer);
            }
            return div;
        }

        // -------------------------- 事件绑定 --------------------------
        function bindEvents() {
            // 1. 新增根零件
            document.getElementById('addRootBtn').addEventListener('click', addRootPart);
            // 2. 新增子零件
            document.getElementById('addChildBtn').addEventListener('click', addChildPart);
            // 3. 删除当前零件
            document.getElementById('deletePartBtn').addEventListener('click', deleteCurrentPart);
            // 4. 保存当前零件信息
            document.getElementById('savePartBtn').addEventListener('click', saveCurrentPart);
            // 5. 树容器事件委托（处理节点点击、图标折叠/展开）
            document.getElementById('treeContainer').addEventListener('click', handleTreeClick);
        }

        // 树容器点击事件委托（减少事件绑定，适配动态节点）
        function handleTreeClick(e) {
            const target = e.target;
            const nodeId = target.dataset.id || target.parentElement.dataset.id;
            if (!nodeId) return;

            // 点击图标：折叠/展开节点
            if (target.classList.contains('node-icon')) {
                toggleNodeExpanded(nodeId);
                return;
            }
            // 点击节点：选中并加载信息
            selectNode(nodeId);
        }

        // -------------------------- 核心操作逻辑 --------------------------
        // 新增根零件
        function addRootPart() {
            const newNode = createNewNode('新根零件');
            partTreeData.push(newNode);
            saveData(); // 保存数据（LocalStorage + 预留云端）
            renderTree();
            selectNode(newNode.id); // 自动选中新节点
        }

        // 新增子零件（仅选中节点时可用）
        function addChildPart() {
            if (!currentNodeId) return;
            const newNode = createNewNode('新子零件');
            const parentNode = findNodeById(currentNodeId);
            if (!parentNode) return;
            // 初始化子节点数组
            if (!parentNode.children) parentNode.children = [];
            parentNode.children.push(newNode);
            parentNode.expanded = true; // 自动展开父节点
            saveData();
            renderTree();
            selectNode(newNode.id);
        }

        // 删除当前零件
        function deleteCurrentPart() {
            if (!currentNodeId) return;
            if (!confirm('确认删除当前零件及所有子零件吗？该操作不可恢复！')) return;
            
            // 删除根节点
            const rootIndex = partTreeData.findIndex(node => node.id === currentNodeId);
            if (rootIndex > -1) {
                partTreeData.splice(rootIndex, 1);
                saveData();
                renderTree();
                resetEditArea(); // 重置编辑区
                return;
            }
            // 删除子节点（递归查找父节点）
            deleteChildNode(currentNodeId, partTreeData);
            saveData();
            renderTree();
            resetEditArea();
        }

        // 保存当前零件信息
        function saveCurrentPart() {
            if (!currentNodeId) return;
            const node = findNodeById(currentNodeId);
            if (!node) return;
            // 获取表单值
            node.name = document.getElementById('partName').value.trim() || node.name;
            node.model = document.getElementById('partModel').value.trim();
            node.material = document.getElementById('partMaterial').value.trim();
            node.remark = document.getElementById('partRemark').value.trim();
            // 验证名称非空
            if (!node.name) {
                alert('零件名称不能为空！');
                document.getElementById('partName').focus();
                return;
            }
            saveData();
            renderTree();
            alert('信息保存成功！');
        }

        // 选中节点并加载信息到编辑区
        function selectNode(nodeId) {
            const node = findNodeById(nodeId);
            if (!node) return;
            // 更新全局选中ID
            currentNodeId = nodeId;
            // 隐藏提示，显示表单
            document.getElementById('editTip').style.display = 'none';
            document.getElementById('partForm').style.display = 'flex';
            // 填充表单数据
            document.getElementById('partName').value = node.name || '';
            document.getElementById('partModel').value = node.model || '';
            document.getElementById('partMaterial').value = node.material || '';
            document.getElementById('partRemark').value = node.remark || '';
            // 重新渲染树（更新高亮）
            renderTree();
        }

        // 折叠/展开节点
        function toggleNodeExpanded(nodeId) {
            const node = findNodeById(nodeId);
            if (!node) return;
            node.expanded = !node.expanded;
            saveData();
            renderTree();
        }

        // 重置编辑区（无选中节点时）
        function resetEditArea() {
            currentNodeId = null;
            document.getElementById('editTip').style.display = 'block';
            document.getElementById('partForm').style.display = 'none';
        }

        // -------------------------- 工具方法 --------------------------
        // 创建新节点（统一格式，方便后续对接云端）
        function createNewNode(name) {
            return {
                id: nodeIdGenerator++, // 唯一ID
                name: name, // 零件名称
                model: '', // 零件型号
                material: '', // 零件材质
                remark: '', // 备注
                expanded: false, // 是否展开
                children: [] // 子节点
            };
        }

        // 递归查找节点（根据ID）
        function findNodeById(id, data = partTreeData) {
            for (const node of data) {
                if (node.id === id) return node;
                if (node.children && node.children.length > 0) {
                    const res = findNodeById(id, node.children);
                    if (res) return res;
                }
            }
            return null;
        }

        // 递归删除子节点
        function deleteChildNode(id, data = partTreeData) {
            for (let i = 0; i < data.length; i++) {
                if (data[i].id === id) {
                    data.splice(i, 1);
                    return true;
                }
                if (data[i].children && data[i].children.length > 0) {
                    const res = deleteChildNode(id, data[i].children);
                    if (res) return true;
                }
            }
            return false;
        }

        // -------------------------- 数据存储模块（LocalStorage + 知晓云预留） --------------------------
        // 从LocalStorage加载数据
        function loadFromLocal() {
            const savedData = localStorage.getItem('gcc-parttree-data');
            const savedId = localStorage.getItem('gcc-parttree-nodeId');
            if (savedData) partTreeData = JSON.parse(savedData);
            if (savedId) nodeIdGenerator = parseInt(savedId) + 1;
            // 后续对接知晓云：在此处调用getFromCloud，优先从云端加载数据
        }

        // 保存数据（LocalStorage + 预留云端保存）
        function saveData() {
            // 保存到LocalStorage
            localStorage.setItem('gcc-parttree-data', JSON.stringify(partTreeData));
            localStorage.setItem('gcc-parttree-nodeId', nodeIdGenerator - 1);
            // 预留：保存到知晓云（后续实现该方法即可，无需修改其他逻辑）
            saveToCloud();
        }

        // -------------------------- 知晓云对接模块（核心预留，后续仅需实现以下方法） --------------------------
        /**
         * 保存数据到知晓云
         * 后续对接：引入知晓云SDK后，实现该方法，将partTreeData同步到云端
         * 可根据用户登录态，将数据关联到当前用户ID，实现多用户数据隔离
         */
        function saveToCloud() {
            // 暂留空方法，后续对接知晓云实现
            // 示例思路：
            // 1. 获取当前登录用户ID（知晓云SDK提供）
            // 2. 将partTreeData和userID一起提交到知晓云云数据库
            // 3. 处理成功/失败回调
        }

        /**
         * 从知晓云加载数据
         * 后续对接：登录成功后调用，根据用户ID加载专属零部件数据
         */
        function getFromCloud() {
            // 暂留空方法，后续对接知晓云实现
            // 示例思路：
            // 1. 获取当前登录用户ID
            // 2. 从知晓云云数据库查询该用户的零部件数据
            // 3. 将返回数据赋值给partTreeData，更新nodeIdGenerator，然后调用renderTree()
        }

        /**
         * 从知晓云删除数据
         * 后续对接：删除零件时，同步删除云端对应数据
         */
        function deleteFromCloud(nodeId) {
            // 暂留空方法，后续对接知晓云实现
        }
    </script>
</body>
</html>
